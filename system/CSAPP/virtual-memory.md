为了更加有效地管理内存并且减少出错，现代操作系统提供了一种对主存的抽象概念，叫做**虚拟内存**（VM，Virtual Memory）。虚拟内存是硬件异常、硬件地址翻译、主存、硬盘文件和内核软件的完美交互，它为每个进程提供了一个大的、一致的、私有的空间。通过一个很清晰的机制，虚拟内存提供了三个重要的能力：

1. 将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据
2. 为每个进程提供了一致的地址空间，从而简化了内存管理
3. 保护了每个进程的地址空间不被其它进程破坏





# 物理和虚拟寻址

计算机系统的主存被组织成一个由M个连续的字节大小的单元组成的数组。每字节都有一个唯一的**物理地址（PA，Physical Address）**。第一个字节的地址为0，接下来是1，2，…，以此类推。CPU访问主存的最自然的方式就是使用物理地址，这种方式称为**物理寻址（physical addressing）**。如图展示了一个物理寻址的示例，该示例的上下文是一条加载指令，它读取从物理地址4处开始的4字节字。当CPU执行这条加载指令时，会生成一个有效物理地址，通过内存总线，把它传递给主存，主存取出从物理地址4处开始的4字节字，并将其返回给CPU，CPU将其存放在一个寄存器里。

图

现代处理器使用称为**虚拟寻址（virtual addressing）**的寻址形式。CPU通过生成一个**虚拟地址（VA，Virtual Address）**来访问主存，这个虚拟地址在被送到内存之前先转换成适当的物理地址。将虚拟地址转换为物理地址的任务叫做**地址翻译（address translation）**。CPU芯片上叫做**内存管理单元（MMU，Memory Management Unit）**的专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理。





# 地址空间

**地址空间（address space）**是一个非负整数地址的有序集合：
$$
\{0,1,2,\cdots\}
$$
如果地址空间中的整数是连续的，我们就称之为**线性地址空间（linear address space）**。在一个带虚拟内存的系统中，CPU从一个有$$N=2^n$$个地址的地址空间中生成虚拟地址，这个地址空间称为**虚拟地址空间（virtual address space）**：
$$
\{0,1,2,\cdots,N-1\}
$$
包含了$$N=2^n$$个地址的虚拟地址空间叫做一个n位地址空间。现代操作系统通常支持32位或64位虚拟地址空间。

系统还有一个**物理地址空间（physical address space）**，对应于系统中物理内存的M个字节：
$$
\{0,1,2,\cdots,M-1\}
$$




# 虚拟内存作为缓存的工具

VM系统将虚拟内存分割为称为**虚拟页（VP，Virtual Page）**的大小固定的块，每个虚拟页的大小为$$P=2^p$$字节。类似地，物理内存被分割为**物理页（PP，Physical Page，也称为页帧，page frame）**，大小也为P字节。

虚拟页面的集合分为三个部分：

+ 未分配的：不占用任何磁盘空间
+ 未缓存的：未缓存在物理内存中的已分配页
+ 缓存的：已缓存在物理内存中的已分配页

图





