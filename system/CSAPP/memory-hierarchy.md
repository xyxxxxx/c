实际上**存储器系统（memory system）**是一个具有不同容量、成本和访问时间的存储设备的层次结构。CPU寄存器保存着最常用的数据；靠近CPU的小的、快速的**高速缓存存储器（cache memory）**作为部分存储在相对慢速的主存储器（main memory）中数据和指令的缓冲区域；主存缓存存储在容量较大的、慢速磁盘上的数据；磁盘又常常作为存储在通过网络连接的其它机器的磁盘或磁带上的数据的缓冲区域。

作为一个程序员，你需要理解存储器层次结构，因为它对应用程序的性能有着巨大的影响。如果你的程序需要的数据存储在CPU寄存器中，那么在指令的执行期间，在0个周期内就能访问到它们；如果存储在高速缓存中，需要4~75个周期；如果存储在主存中，需要上百个周期；而如果存储在磁盘上，则需要大约几千万个周期！因此编写应用程序时，应尽量使数据项存储在层次结构较高的地方，在那里CPU可以更快地访问它们。

程序具有一个称为**局部性（locality）**的基本属性。具有良好局部性的程序倾向于一次又一次地访问相同的数据项集合，或是倾向于访问临近的数据项集合。具有良好局部性的程序比局部性差的程序更多地倾向于从存储器层次结构中较高层次处访问数据项，因此运行得更快。例如在Core i7系统，不同的矩阵乘法核心程序执行相同数量的算数操作，但是因为不同程度的局部性，运行时间可以相差40倍！





# 存储技术

## 随机访问存储器

**随机访问存储器（RAM，Random-Access Memory）**分为两类：静态的和动态的。静态RAM（SRAM）比动态RAM（DRAM）更快，但也贵得多。<u>SRAM用来作为高速缓存存储器</u>，既可以在CPU芯片上，也可以在片下；DRAM用来作为主存以及图形系统的帧缓冲区。典型地，一个桌面系统的SRAM不会超过几兆字节，但是DRAM却有几千兆字节。



SRAM和DRAM的介绍略。



### 传统的DRAM

DRAM芯片中的所有单元（位）被分为$$d$$个**超单元（supercell）**，每个超单元都由$$w$$个DRAM单元组成。一个$$d\times w$$的DRAM总共存储了$$dw$$位信息。超单元被组织为一个$$r$$行$$c$$列的矩阵，这里$$rc=d$$。每个超单元有形如$$(i,j)$$的地址，其中$$i$$表示行，$$j$$表示列。

例如，下图展示了一个16×8的DRAM芯片的组织，有$$d=16$$个超单元，每个超单元有$$w=8$$个单元（位），$$r=4, c=4$$。带阴影的方框表示地址(2, 1)处的超单元。信息通过称为**引脚（pin）**的外部连接器流入和流出芯片。每个引脚携带1位的信号。下图给出了两组引脚：8个`data`引脚，它们能传送一个字节到芯片或从芯片传出一个字节；2个`addr`引脚，它们携带2位的行和列超单元地址。其它携带控制信息的引脚没有显示出来。

图6-3

每个DRAM芯片被连接到称为**内存控制器（memory controller）**的电路，这个电路可以<u>一次传送$$w$$位到*每个*DRAM芯片或一次从*每个*DRAM芯片传出$$w$$位</u>。为了读出超单元$$(i,j)$$的内容，内存控制器将行地址$$i$$发送到DRAM，然后发送列地址$$j$$。DRAM把超单元$$(i,j)$$的内容发回控制器作为响应。行地址$$i$$称为**RAS（Row Access Strobe, 行访问选通脉冲）**请求，列地址$$j$$称为**CAS（Column Access Strobe, 列访问选通脉冲）**请求。注意RAS和CAS请求共享相同的DRAM地址引脚。

例如，要从上图中16×8的DRAM读出超单元(2, 1)，内存控制器发送行地址2，如下图a所示，DRAM的响应是将行2的整个内容都复制到一个内部行缓冲区。然后，内存控制器发送列地址1，如下图b所示，DRAM的响应是从行缓冲区复制出超单元(2, 1)中的8位，并把它们发送到内存控制器。

图6-4

电路设计者将DRAM组织成二维阵列而不是线性数组的一个原因是降低芯片上地址引脚的数量。例如，如果示例的128位DRAM被组织成一个16个超单元的线性数组，地址为0~15，那么芯片会需要4个地址引脚而不是2个。二维阵列组织节约了地址引脚的数量，但增加了发送地址的次数，这增加了访问时间。



### 内存模块

DRAM芯片封装在**内存模块（memory module）**中，它插在主板的扩展槽上。Core i7系统使用240个引脚的**双列直插内存模块（Dual Inline Memory Module, DIMM）**，它以64位为块传送数据到内存控制器和从内存控制器传出数据。

下图展示了一个内存模块的基本思想。示例模块用8个8M的DRAM芯片，总共存储64MB，这8个芯片编号为0~7。每个**超单元（supercell）**存储主存的一个字节，而用地址为$$(i, j)$$的8个超单元来表示主存中字节地址A处的64位字。下图的示例中，DRAM 0存储第一个（低位）字节，DRAM 1存储下一个字节，以此类推。

图6-5

要取出内存地址A处的一个64位字，<u>内存控制器将A转换为一个超单元地址$$(i,j)$$，并将它发送到内存模块，然后内存模块再将$$i$$和$$j$$广播到每个DRAM</u>。作为响应，<u>每个DRAM输出它的$$(i,j)$$超单元的8位内容，内存模块的电路收集这些输出，并把它们合并成一个64位字，再返回给内存控制器</u>。

通过<u>将多个内存模块连接到内存控制器</u>，能够聚合成主存。在这种情况中，当控制器收到一个地址A时，控制器选择包含A的模块$$k$$，将A转换称它的$$(i,j)$$形式，并将$$(i,j)$$发送到模块$$k$$。



### 非易失性存储器

如果断电，DRAM和SRAM会丢失它们的信息，从这个意义上说，它们是**易失的（volatile）**；**非易失性存储器（nonvolatile memory）**即使在关电后，仍然保存着它们的信息。现在有很多种非易失性存储器。

由于历史原因，虽然ROM中有的类型既可以读又可以写，但是它们整体上都被称为**只读存储器（Read-Only Memory, ROM）**。ROM以它们能够被重编程（写）的次数和对它们进行重编程（写）的机制来区分。

**PROM（Programmable ROM, 可编程ROM）**只能被编程一次。PROM的每个存储器单元有一种熔丝（fuse），只能用高电流熔断一次。

**EPROM（Erasable PROM, 可擦除可编程ROM）**有一个透明的石英窗口，允许光到达存储单元；紫外线光照射过窗口，EPROM单元就被清除为0。对EPROM编程是通过使用一种把1写入EPROM的特殊设备来完成的。EPROM能够被擦除和重编程的次数的数量级可以达到1000次。

**EEPROM（Electrically Erasable PROM, 电子可擦除可编程ROM）**类似于EPROM，但是它不需要一个物理上独立的编程设备，因此可以直接在印制电路卡上编程。EEPROM能够被编程的次数的数量级可以达到$$10^5$$次。

**闪存（flash memory）**是一类非易失性存储器，基于EEPROM，它已经成为了一种重要的存储技术。闪存无处不在，为大量的电子设备提供快速而持久的非易失性存储。在后面我们会仔细研究一种新型的基于闪存的磁盘驱动器，称为**固态硬盘（Solid State Disk, SSD）**，它能提供相对于传统旋转磁盘的一种更快速、更强健和更低能耗的选择。

存储在ROM设备中的程序通常被称为**固件（firmware）**。当一个计算机系统通电以后，它会运行存储在ROM中的固件。一些系统在固件中提供了少量基本的输入输出函数，例如主板的BIOS（基本输入输出系统）例程。复杂的设备，像图形卡和磁盘驱动控制器，也依赖固件翻译来自CPU的I/O请求。



### 访问主存

数据流通过称为**总线（bus）**的共享电子电路在处理器和DRAM主存之间来来回回。每次CPU和主存之间的数据传送都是通过一系列步骤来完成的，这些步骤称为**总线事务（bus transaction）**。**读事务（read transaction）**从主存传送数据到CPU，**写事务(write transaction)**从CPU传送数据到主存。

<u>总线是一组并行的导线，能够携带地址、数据和控制信号</u>。两个以上的设备可以共享同一总线。控制线携带的信号会同步事务，并标识出当前正在被执行的事务的类型。

下图展示了一个示例计算机系统的配置。主要部件是CPU芯片、称为**I/O桥接器（I/O bridge）**的芯片组（其中包括内存控制器），以及组成主存



