# 概述

## 推荐系统的作用

从用户的角度看，推荐系统解决在信息过载的情况下如何高效获取感兴趣的信息的问题；而从公司的角度看，推荐系统解决产品能够最大限度地吸引用户、留存用户、增加用户粘性、提高用户转化率的问题。这两个维度的优化目标是推荐系统功能的一体两面：

|          | 公司盈利模式                                             | 用户目标             |
| -------- | -------------------------------------------------------- | -------------------- |
| Youtube  | 广告为主要收入来源，广告总曝光次数与用户总观看时间成正比 | 观看更多感兴趣的视频 |
| 电商     | 推荐合适的商品直接提高了购买转化率                       | 买到想要的物品       |
| 新闻媒体 |                                                          |                      |

针对不同的公司业务，优化目标也有所不同：例如视频网站注重观看时长，电商注重购买转化率，而新闻媒体更注重点击率。



## 推荐系统与搜索引擎





## 推荐系统的框架

推荐系统要处理的问题可以较形式化地定义为：对于用户$$u$$ (user) ，在特定场景$$c$$ (context) 下，针对海量的物品信息，构建一个函数$$f(u,i,c)$$，预测用户对特定候选物品$$i$$ (item)的喜好程度，再根据喜好程度对所有候选物品进行排序，生成推荐列表的问题。



## 推荐系统的数据处理部分



## 推荐系统的模型部分

模型结构一般由召回层，排序层和补充策略与算法层组成：

+ **召回层(retrieve)** 一般利用高效的召回规则、算法或简单的模型，快速地从海量的候选集中召回用户可能感兴趣的物品。
+ **排序层(ranking)** 利用排序模型对初筛的候选集进行精排序。
+ **补充策略与算法层** 也称为在排序层，可以在推荐列表返回用户之前，为兼顾结果的多样性、流行度、新鲜度等指标，结合一些补充的策略和算法对推荐列表进行一定的调整，从而形成用户可见的推荐列表。

模型训练根据训练环境不同，分为**离线训练**和**在线训练**：离线训练的优点是可以利用全量样本和特征使模型逼近（全局/局部）最优点，在线训练则可以准实时地消化新的数据样本，更快地反映新的数据变化趋势，满足模型的实时性需求。





# 古典模型

## CF

**协同过滤(Collaborative Filtering, CF)**是最经典的推荐系统算法。顾名思义，协同过滤就是协同大家的反馈、评价和意见共同对海量信息进行过滤，从中筛选出目标用户可能感兴趣的物品的过程。

考虑在某平台上，用户对物品给出了以下的评价：

| 用户\物品 | a    | b    | c    | d    |
| --------- | ---- | ---- | ---- | ---- |
| u         | 好评 | 差评 | 好评 | 好评 |
| v         |      | 好评 | 差评 | 差评 |
| w         | 好评 | 好评 | 差评 |      |
| x         | 差评 |      | 好评 |      |
| y         | 好评 | 好评 | ?    | 差评 |

这时求问号处的评价更接近好评还是差评，即平台是否该将物品c推荐给用户y？

为便于计算，将上述数据转换为数值，即：

| 用户\物品 | a   | b   | c   | d   |
| --------- | ---- | ---- | ---- | ---- |
| u       | 1    | -1   | 1 | 1 |
| v       | 0 | 1 | -1 | -1 |
| w       | 1 | 1 | -1 | 0 |
| x       | -1 | 0 | 1 | 0 |
| y       | 1 | 1 | 0 (?) | -1 |



### UserCF

**基于用户的协同过滤(UserCF)**基于用户相似度进行推荐，它符合实际生活中的“兴趣相似的同好喜欢的物品，我也很可能喜欢”的观念。在上例中，其具体过程为：

1. 计算共现矩阵行向量（即用户）两两之间的相似性，构建$$m\times m$$维用户相似度矩阵，计算方法可以为余弦相似度（向量夹角），皮尔逊相关系数或使用物品平均分的类似皮尔逊相关系数。
   $$
   余弦相似度\ {\rm sim}(\pmb u,\pmb v)=\cos(\pmb u,\pmb v)=\frac{\pmb u\cdot\pmb v}{\|\pmb u\|\cdot\|\pmb v\|}\\
   皮尔逊相关系数\ {\rm sim}(\pmb u,\pmb v)=\frac{\sum_{i\in I}(r_{u,i}-\bar{r}_u)(r_{v,i}-\bar{r}_v)}{\sqrt{\sum_{i\in I}(r_{u,i}-\bar{r}_u)}\sqrt{\sum_{i\in I}(r_{v,i}-\bar{r}_v)}}\\
   类似皮尔逊相关系数\ {\rm sim}(\pmb u,\pmb v)=\frac{\sum_{i\in I}(r_{u,i}-\bar{r}_i)(r_{v,i}-\bar{r}_i)}{\sqrt{\sum_{i\in I}(r_{u,i}-\bar{r}_i)}\sqrt{\sum_{i\in I}(r_{v,i}-\bar{r}_i)}}\\
   $$
   
   > 理论上，任何合理的向量相似度定义方法都可以作为标准，因此在这里也可以做出各种改进。
2. 对于特定用户y，找到与其相似度最高的$$k$$个用户（$$k$$为超参数）。

3. 利用Top $$k$$相似用户对物品c的评价进行预测，或者更进一步，从所有的（y未评价的）物品中选出$$k_1$$个推荐给用户y，最常用的方式是利用加权平均得到y对每个物品的评价预测，排序并从中选取最大的$$k_1$$个值。
   $$
   r_{u,i}=\frac{\sum_{s\in S}(w_{u,s}\cdot r_{s,i})}{\sum_{s\in S}w_{u,s}}
   $$
   其中权重$$w_{u,s}$$是用户$$u$$与其相似用户$$s$$的相似度，$$r_{s,i}$$是用户$$s$$对物品$$p$$的评分。



UserCF包含以下2个缺点：

1. 在互联网的实际应用场景下，用户数往往远大于物品数，而UserCF需要维护用户相似度矩阵，即一个$$m\times m$$矩阵，该矩阵的存储开销非常大，且增长十分迅速。
2. 用户的历史数据向量往往十分稀疏，对于只有几次点击、购买或评价行为的用户而言，找到相似用户的准确率非常低。



### ItemCF

**基于物品的协同过滤(ItemCF)**则基于物品相似度进行推荐，它符合实际生活中的“与我喜欢的物品相似的物品，我也很可能喜欢”的观念。在上例中，其具体过程为：

1. 计算共现矩阵列向量（即物品）两两之间的相似性，构建$$n\times n$$维物品相似度矩阵，计算方法同上。

2. 对于特定用户y，找到其历史行为数据中的正反馈（和负反馈）物品列表。

3. 利用正反馈（和负反馈）物品列表计算物品c的相似度，或者更进一步，计算所有（y未评价的）物品的相似度，排序并从中选取最大的$$k$$个值。注意这里如果某个物品与多个正反馈（和负反馈物品）相似，其相似度是叠加的。
   $$
   r_{u,i}=\sum_{t\in T}(w_{i,t}\cdot r_{u,t})
   $$



### 比较

两种协同过滤方法由于实现思路上的不同，其具体应用场景上也有所不同。

+ UserCF基于用户相似度进行推荐，使得其具备更强的社交属性，用户能够快速获知与自己兴趣相似的人最近喜欢的是什么，即使某个兴趣点以前不在自己的兴趣范围内。SNS上的分享推荐即具有此种属性，例如闺蜜之间推荐新化妆品，死宅之间推荐新游戏。此外UserCF也擅长发现热点和跟踪热点，因此非常适用于热搜和新闻推荐等场景。
+ ItemCF基于物品相似度进行推荐，更适用于兴趣变化较为稳定的应用，例如在电商平台上用户倾向于寻找特定类别的商品，视频网站上用户观看的视频类型也往往比较稳定。



### 小结

协同过滤是一个非常直观、可解释性很强的模型，但它有一个严重的问题——热门的物品具有很强的头部效应，容易和大量物品产生相似性；而尾部的物品由于特征向量稀疏，很少与其它物品产生相似性，从而很少被推荐。

举例来说，考虑以下共现矩阵：

图2.3

可以看到，物品D与所有其它物品都具有相似性，因此在以ItemCF为基础构建的推荐系统中被推荐给所有对A、B、C有过正反馈的用户，但其原因仅为D是一个热门商品。对D的推荐会进一步增加D的热门程度，从而导致头部效应，或者说马太效应。另一方面，商品A、B、C之间无法计算相似度，原因为它们的特征向量非常稀疏。由此印证了前面的问题，即头部效应明显，而处理稀疏向量的能力弱。

此外，协同过滤仅利用了用户和物品的交互信息，而未利用用户年龄、性别、教育水平、职业等用户信息，商品分类、描述等商品信息，当前日期、时间、位置等环境信息，这无疑造成了有效信息的遗漏。



## FM

**因子分解(矩阵分解, Factorization Machine, FM)**针对协同过滤算法的头部效应明显、处理稀疏向量能力弱的问题而被提出。